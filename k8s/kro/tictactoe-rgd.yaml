apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: tictactoe-application
spec:
  schema:
    apiVersion: v1alpha1
    kind: TicTacToeApp
    spec:
      environment: string | required=true description="Environment name (dev, staging, prod)"
      imageTag: string | required=true description="Image tag for frontend and backend"
      replicas: integer | default=1 minimum=1 maximum=10 description="Number of frontend replicas"
      backendReplicas: integer | default=1 minimum=1 maximum=10 description="Number of backend replicas"
      cpuRequest: string | default="10m"
      cpuLimit: string | default="100m"
      memoryRequest: string | default="16Mi"
      memoryLimit: string | default="64Mi"
    status:
      frontendReady: ${frontendDeployment.status.availableReplicas >= frontendDeployment.spec.replicas}
      backendReady: ${backendDeployment.status.availableReplicas >= backendDeployment.spec.replicas}

  resources:
    # Namespace
    - id: appNamespace
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: tictactoe-${schema.spec.environment}

    # Nginx ConfigMap
    - id: nginxConfig
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: nginx-config
          namespace: ${appNamespace.metadata.name}
        data:
          nginx.conf: |
            worker_processes auto;
            error_log /dev/stderr warn;
            pid /run/nginx.pid;
            events { worker_connections 1024; }
            http {
                include /etc/nginx/mime.types;
                default_type application/octet-stream;
                log_format json_combined escape=json '{"time":"$time_iso8601","remote_addr":"$remote_addr","method":"$request_method","uri":"$uri","status":$status,"body_bytes_sent":$body_bytes_sent,"request_time":$request_time}';
                access_log /dev/stdout json_combined;
                sendfile on;
                keepalive_timeout 65;
                client_body_temp_path /var/lib/nginx/tmp/client_body;
                proxy_temp_path /var/lib/nginx/tmp/proxy;
                fastcgi_temp_path /var/lib/nginx/tmp/fastcgi;
                uwsgi_temp_path /var/lib/nginx/tmp/uwsgi;
                scgi_temp_path /var/lib/nginx/tmp/scgi;
                server {
                    listen 8080;
                    server_name localhost;
                    root /usr/share/nginx/html;
                    index index.html;
                    sub_filter '__ENV__' '${schema.spec.environment}';
                    sub_filter_once off;
                    sub_filter_types text/html application/javascript;
                    location / { try_files $uri $uri/ =404; }
                    location /stub_status { stub_status; allow 127.0.0.1; deny all; }
                    location /healthz { return 200 'ok'; add_header Content-Type text/plain; }
                }
            }

    # Frontend Deployment
    - id: frontendDeployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: tictactoe
          namespace: ${appNamespace.metadata.name}
        spec:
          replicas: ${schema.spec.replicas}
          selector:
            matchLabels:
              app: tictactoe
          template:
            metadata:
              labels:
                app: tictactoe
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "9113"
                prometheus.io/path: "/metrics"
            spec:
              securityContext:
                runAsNonRoot: true
                runAsUser: 65532
                runAsGroup: 65532
                fsGroup: 65532
              initContainers:
              - name: init-dirs
                image: busybox:stable
                command: ['sh', '-c', 'mkdir -p /var/lib/nginx/tmp/client_body /var/lib/nginx/tmp/proxy /var/lib/nginx/tmp/fastcgi /var/lib/nginx/tmp/uwsgi /var/lib/nginx/tmp/scgi']
                securityContext:
                  runAsUser: 65532
                  runAsGroup: 65532
                volumeMounts:
                - name: lib
                  mountPath: /var/lib/nginx
              containers:
              - name: tictactoe
                image: ghcr.io/pnz1990/tictactoe-k8s:${schema.spec.imageTag}
                ports:
                - containerPort: 8080
                  name: http
                resources:
                  requests:
                    cpu: ${schema.spec.cpuRequest}
                    memory: ${schema.spec.memoryRequest}
                  limits:
                    cpu: ${schema.spec.cpuLimit}
                    memory: ${schema.spec.memoryLimit}
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  capabilities:
                    drop: [ALL]
                livenessProbe:
                  httpGet:
                    path: /
                    port: 8080
                  initialDelaySeconds: 5
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /
                    port: 8080
                  initialDelaySeconds: 3
                  periodSeconds: 5
                volumeMounts:
                - name: tmp
                  mountPath: /tmp
                - name: cache
                  mountPath: /var/cache/nginx
                - name: run
                  mountPath: /run
                - name: lib
                  mountPath: /var/lib/nginx
                - name: nginx-conf
                  mountPath: /etc/nginx/nginx.conf
                  subPath: nginx.conf
              - name: metrics
                image: nginx/nginx-prometheus-exporter:1.5
                args:
                - -nginx.scrape-uri=http://localhost:8080/stub_status
                ports:
                - containerPort: 9113
                  name: metrics
                resources:
                  requests:
                    cpu: 5m
                    memory: 8Mi
                  limits:
                    cpu: 50m
                    memory: 32Mi
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  capabilities:
                    drop: [ALL]
              volumes:
              - name: tmp
                emptyDir: {}
              - name: cache
                emptyDir: {}
              - name: run
                emptyDir: {}
              - name: lib
                emptyDir: {}
              - name: nginx-conf
                configMap:
                  name: nginx-config

    # Frontend Service
    - id: frontendService
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: tictactoe
          namespace: ${appNamespace.metadata.name}
          labels:
            app: tictactoe
        spec:
          selector:
            app: tictactoe
          ports:
          - port: 80
            targetPort: 8080
            name: http
          - port: 9113
            targetPort: 9113
            name: metrics

    # Backend Deployment
    - id: backendDeployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: tictactoe-backend
          namespace: ${appNamespace.metadata.name}
        spec:
          replicas: ${schema.spec.backendReplicas}
          selector:
            matchLabels:
              app: tictactoe-backend
          template:
            metadata:
              labels:
                app: tictactoe-backend
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "8081"
                prometheus.io/path: "/metrics"
            spec:
              securityContext:
                runAsNonRoot: true
                runAsUser: 65532
                runAsGroup: 65532
                fsGroup: 65532
                seccompProfile:
                  type: RuntimeDefault
              containers:
              - name: backend
                image: ghcr.io/pnz1990/tictactoe-k8s-backend:${schema.spec.imageTag}
                ports:
                - containerPort: 8081
                  name: http
                resources:
                  requests:
                    cpu: 10m
                    memory: 32Mi
                  limits:
                    cpu: 100m
                    memory: 128Mi
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  capabilities:
                    drop: [ALL]
                livenessProbe:
                  httpGet:
                    path: /healthz
                    port: 8081
                  initialDelaySeconds: 5
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /healthz
                    port: 8081
                  initialDelaySeconds: 3
                  periodSeconds: 5

    # Backend Service
    - id: backendService
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: tictactoe-backend
          namespace: ${appNamespace.metadata.name}
        spec:
          selector:
            app: tictactoe-backend
          ports:
          - port: 80
            targetPort: 8081
            name: http

    # Ingress
    - id: ingress
      template:
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: tictactoe
          namespace: ${appNamespace.metadata.name}
          annotations:
            alb.ingress.kubernetes.io/scheme: internet-facing
            alb.ingress.kubernetes.io/target-type: ip
        spec:
          ingressClassName: alb
          rules:
          - http:
              paths:
              - path: /api
                pathType: Prefix
                backend:
                  service:
                    name: tictactoe-backend
                    port:
                      number: 80
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: tictactoe
                    port:
                      number: 80

    # PodDisruptionBudget - Frontend
    - id: frontendPdb
      template:
        apiVersion: policy/v1
        kind: PodDisruptionBudget
        metadata:
          name: tictactoe
          namespace: ${appNamespace.metadata.name}
        spec:
          minAvailable: 1
          selector:
            matchLabels:
              app: tictactoe

    # PodDisruptionBudget - Backend
    - id: backendPdb
      template:
        apiVersion: policy/v1
        kind: PodDisruptionBudget
        metadata:
          name: tictactoe-backend
          namespace: ${appNamespace.metadata.name}
        spec:
          minAvailable: 1
          selector:
            matchLabels:
              app: tictactoe-backend


    # Grafana Ops Dashboard
    - id: opsDashboard
      template:
        apiVersion: grafana.integreatly.org/v1beta1
        kind: GrafanaDashboard
        metadata:
          name: tictactoe-ops
          namespace: ${appNamespace.metadata.name}
        spec:
          allowCrossNamespaceImport: true
          instanceSelector:
            matchLabels:
              dashboards: "amg"
          json: |
            {
              "title": "Tic Tac Toe Ops - ${schema.spec.environment}",
              "uid": "tictactoe-ops-${schema.spec.environment}",
              "time": {"from": "now-1h", "to": "now"},
              "refresh": "30s",
              "panels": [
                {"id": 1, "title": "Frontend - HTTP Requests/sec", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 0, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "rate(nginx_http_requests_total{namespace=\"tictactoe-${schema.spec.environment}\"}[5m])"}]},
                {"id": 2, "title": "Frontend - Active Connections", "type": "stat", "gridPos": {"h": 6, "w": 4, "x": 8, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "nginx_connections_active{namespace=\"tictactoe-${schema.spec.environment}\"}"}]},
                {"id": 3, "title": "Frontend - Up", "type": "stat", "gridPos": {"h": 6, "w": 4, "x": 12, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "nginx_up{namespace=\"tictactoe-${schema.spec.environment}\"}"}], "fieldConfig": {"defaults": {"mappings": [{"type": "value", "options": {"1": {"text": "UP", "color": "green"}, "0": {"text": "DOWN", "color": "red"}}}]}}},
                {"id": 4, "title": "Backend - Requests/sec", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 16, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(rate(http_requests_total{namespace=\"tictactoe-${schema.spec.environment}\"}[5m])) by (endpoint)", "legendFormat": "{{endpoint}}"}]},
                {"id": 5, "title": "Backend - Request Duration (p99)", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 0, "y": 6}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{namespace=\"tictactoe-${schema.spec.environment}\"}[5m])) by (le, endpoint))", "legendFormat": "{{endpoint}}"}], "fieldConfig": {"defaults": {"unit": "s"}}},
                {"id": 6, "title": "Backend - In-Flight Requests", "type": "stat", "gridPos": {"h": 6, "w": 4, "x": 8, "y": 6}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "http_requests_in_flight{namespace=\"tictactoe-${schema.spec.environment}\"}"}]},
                {"id": 7, "title": "Backend - Error Rate", "type": "stat", "gridPos": {"h": 6, "w": 4, "x": 12, "y": 6}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(rate(http_requests_total{namespace=\"tictactoe-${schema.spec.environment}\", status!=\"OK\"}[5m])) / sum(rate(http_requests_total{namespace=\"tictactoe-${schema.spec.environment}\"}[5m])) * 100 or vector(0)"}], "fieldConfig": {"defaults": {"unit": "percent", "thresholds": {"steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 1}, {"color": "red", "value": 5}]}}}},
                {"id": 8, "title": "Backend - Go Goroutines", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 16, "y": 6}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "go_goroutines{namespace=\"tictactoe-${schema.spec.environment}\"}"}]},
                {"id": 9, "title": "Backend - Memory Usage", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 0, "y": 12}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "go_memstats_heap_inuse_bytes{namespace=\"tictactoe-${schema.spec.environment}\"}", "legendFormat": "Heap In Use"}, {"refId": "B", "expr": "go_memstats_heap_alloc_bytes{namespace=\"tictactoe-${schema.spec.environment}\"}", "legendFormat": "Heap Alloc"}], "fieldConfig": {"defaults": {"unit": "bytes"}}},
                {"id": 10, "title": "Backend - GC Duration", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 8, "y": 12}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "rate(go_gc_duration_seconds_sum{namespace=\"tictactoe-${schema.spec.environment}\"}[5m])"}], "fieldConfig": {"defaults": {"unit": "s"}}},
                {"id": 11, "title": "Backend CPU Usage", "type": "timeseries", "gridPos": {"h": 6, "w": 8, "x": 16, "y": 12}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "rate(process_cpu_seconds_total{namespace=\"tictactoe-${schema.spec.environment}\", app=\"tictactoe-backend\"}[5m])", "legendFormat": "backend"}], "fieldConfig": {"defaults": {"unit": "percentunit"}}}
              ]
            }

    # Grafana Business Dashboard
    - id: businessDashboard
      template:
        apiVersion: grafana.integreatly.org/v1beta1
        kind: GrafanaDashboard
        metadata:
          name: tictactoe-business
          namespace: ${appNamespace.metadata.name}
        spec:
          allowCrossNamespaceImport: true
          instanceSelector:
            matchLabels:
              dashboards: "amg"
          json: |
            {
              "title": "Tic Tac Toe Business - ${schema.spec.environment}",
              "uid": "tictactoe-biz-${schema.spec.environment}",
              "time": {"from": "now-24h", "to": "now"},
              "refresh": "30s",
              "panels": [
                {"id": 1, "title": "ðŸ† Leaderboard - Top Players (24h)", "type": "table", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "topk(10, sum by (player) (tictactoe_wins_total{namespace=\"tictactoe-${schema.spec.environment}\"}))", "legendFormat": "{{player}}", "instant": true, "format": "table"}], "transformations": [{"id": "organize", "options": {"excludeByName": {"Time": true}, "renameByName": {"player": "Player", "Value": "Wins"}}}]},
                {"id": 2, "title": "ðŸ“Š Total Games (24h)", "type": "stat", "gridPos": {"h": 4, "w": 4, "x": 12, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(increase(tictactoe_games_total{namespace=\"tictactoe-${schema.spec.environment}\"}[24h]))"}], "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "blue", "value": null}]}}}},
                {"id": 3, "title": "ðŸŽ¯ Total Wins (24h)", "type": "stat", "gridPos": {"h": 4, "w": 4, "x": 16, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(increase(tictactoe_games_total{namespace=\"tictactoe-${schema.spec.environment}\", result=\"win\"}[24h]))"}], "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}]}}}},
                {"id": 4, "title": "ðŸ¤ Total Ties (24h)", "type": "stat", "gridPos": {"h": 4, "w": 4, "x": 20, "y": 0}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(increase(tictactoe_ties_total{namespace=\"tictactoe-${schema.spec.environment}\"}[24h]))"}], "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "yellow", "value": null}]}}}},
                {"id": 5, "title": "ðŸŽ² Winning Patterns (24h)", "type": "piechart", "gridPos": {"h": 8, "w": 8, "x": 12, "y": 4}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum by (pattern) (increase(tictactoe_wins_total{namespace=\"tictactoe-${schema.spec.environment}\"}[24h]))", "legendFormat": "{{pattern}}"}], "options": {"legend": {"displayMode": "table", "placement": "right"}}},
                {"id": 6, "title": "ðŸ“ˆ Games Over Time", "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "sum(increase(tictactoe_games_total{namespace=\"tictactoe-${schema.spec.environment}\", result=\"win\"}[1h]))", "legendFormat": "Wins/hr"}, {"refId": "B", "expr": "sum(increase(tictactoe_games_total{namespace=\"tictactoe-${schema.spec.environment}\", result=\"tie\"}[1h]))", "legendFormat": "Ties/hr"}], "fieldConfig": {"defaults": {"unit": "short"}}},
                {"id": 7, "title": "ðŸ”¥ Current Win Streaks", "type": "bargauge", "gridPos": {"h": 8, "w": 8, "x": 12, "y": 12}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "topk(5, tictactoe_current_win_streak{namespace=\"tictactoe-${schema.spec.environment}\"} > 0)", "legendFormat": "{{player}}"}], "options": {"orientation": "horizontal", "displayMode": "gradient"}, "fieldConfig": {"defaults": {"color": {"mode": "continuous-GrYlRd"}, "min": 0, "max": 10}}},
                {"id": 8, "title": "ðŸ‘¥ Most Active Players (24h)", "type": "bargauge", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}, "datasource": {"type": "prometheus", "uid": "ef58nw8xkcf7kf"}, "targets": [{"refId": "A", "expr": "topk(10, sum by (player) (increase(tictactoe_player_games_total{namespace=\"tictactoe-${schema.spec.environment}\"}[24h])))", "legendFormat": "{{player}}"}], "options": {"orientation": "horizontal", "displayMode": "gradient"}, "fieldConfig": {"defaults": {"color": {"mode": "continuous-BlPu"}}}}
              ]
            }
